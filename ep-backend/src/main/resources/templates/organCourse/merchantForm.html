<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout">
<head th:replace="~{fragments/header :: common_header}">
</head>
<header>
    <th:block layout:fragment="links">
        <link th:href="@{/umeditor/themes/default/css/umeditor.css}" rel="stylesheet">
    </th:block>
    <style>
        .course-label {
            font-size: 20px;
            font-weight: bold
        }
    </style>
</header>
<body class="gray-bg">
<!--<iframe id="mapPage" width="100%" height="100%" frameborder=0 src="http://apis.map.qq.com/tools/locpicker?search=1&type=1&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&referer=myapp"></iframe>-->
<div class="col-sm-11 ">
    <div style="padding-left: 40px" class="row ">
        <input id="ognPhone" th:value="${ognPhone}" type="hidden">
        <input id="ognLng" th:value="${ognLng}" type="hidden">
        <input id="ognLat" th:value="${ognLat}" type="hidden">
        <input id="ognAddress" th:value="${ognAddress}" type="hidden">
        <form id="frm">
            <div class="col-sm-12 ">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <label class="course-label">产品详情（<span class="required-sign">*为必填</span>）</label>
                        <a style="display: inline-block;float: right" class="btn btn-xs btn-danger"
                           href="javascript:void(0)" onclick="history.back()">返回</a>

                    </div>
                    <div class="ibox-content" style="">
                        <div class="row" th:object="${organCoursePo}">
                            <div class="col-sm-6">
                                <input id="courseId" name="organCoursePo.id" type="hidden"
                                       th:value="${organCoursePo.id}">
                                <input id="ognId" type="hidden" th:value="${organCoursePo.ognId}">
                                <div class="form-group ">
                                    <label for="courseName">产品名称 <span class="required-sign">*</span></label>
                                    <input id="courseName" name="organCoursePo.courseName" type="text"
                                           th:value="${organCoursePo.courseName}"
                                           required="true" aria-required="true" class=" form-control">
                                </div>
                                <div class="form-group">
                                    <label for="courseType">产品类型 <span class="required-sign">*</span></label>
                                    <select id="courseType" name="organCoursePo.courseType" type="text"
                                            required="true"
                                            class=" form-control ">
                                        <option value="">请选择</option>
                                        <option th:each="state : ${T(com.ep.domain.repository.domain.enums.EpOrganCourseCourseType).values()}"
                                                th:selected="${#strings.equals(organCoursePo.courseType,state)}"
                                                th:value="${state}"
                                                th:text="#{EpOrganCourseCourseType.+${state.literal}}">
                                        </option>
                                    </select>

                                </div>
                                <div class="form-group" style="overflow:hidden">
                                    <label for="courseCatalogId">产品科目 <span class="required-sign">*</span></label>
                                    <div>
                                        <div class="col-sm-6">
                                            <select id="firstConstantCatalogId"
                                                    required="true" style="margin-left: -15px"
                                                    onchange="changeFirstCatalog()"
                                                    class="form-control">
                                                <option value="">一级目录</option>
                                                <option th:each="po : ${firstConstantCatalogSelectModel}"
                                                        th:value="${po.id}"
                                                        th:text="${po.label}">
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-sm-6">
                                            <select id="courseCatalogId" name="organCoursePo.courseCatalogId"
                                                    class="form-control" style="margin-left: 15px">
                                                <option value="">二级目录</option>
                                            </select>
                                        </div>
                                    </div>

                                </div>
                                <div class="form-group">
                                    <label for="courseIntroduce">产品简介 </label>
                                    <textarea id="courseIntroduce" name="organCoursePo.courseIntroduce" type="text"
                                              style="height:80px"
                                              placeholder="最多输入20个字" maxlength="20"
                                              class="form-control"
                                              th:text="${organCoursePo.courseIntroduce}"></textarea>

                                </div>

                                <div class="form-group">
                                    <label for="onlineTime">上线时间 <span class="required-sign">*</span></label>
                                    <input id="onlineTime" name="organCoursePo.onlineTime" type="text"
                                           required="true" class="form-control laydate"
                                           th:value="${#dates.format(organCoursePo.onlineTime,'yyyy-MM-dd HH:mm:ss')}">

                                </div>
                                <div class="form-group">
                                    <label for="enterTimeStart">报名开始时间 <span class="required-sign">*</span></label>
                                    <input id="enterTimeStart" name="organCoursePo.enterTimeStart" type="text"
                                           required="true" class="form-control laydate"
                                           th:value="${#dates.format(organCoursePo.enterTimeStart,'yyyy-MM-dd HH:mm:ss')}">

                                </div>
                                <div class="form-group">
                                    <label for="enterTimeEnd">报名结束时间 </label>
                                    <input id="enterTimeEnd" name="" type="text"
                                           class="form-control laydate"
                                           th:value="${#dates.format(organCoursePo.enterTimeEnd,'yyyy-MM-dd HH:mm:ss')}">

                                </div>
                                <div class="form-group" th:if="${organVipFlag}">
                                    <label for="vipFlag">是否<span th:text="${organVipName}"></span>才能报名 <span
                                            class="required-sign">*</span></label>
                                    <select id="vipFlag" name="organCoursePo.vipFlag" type="text"
                                            required="true" class="form-control" th:value="${organCoursePo.vipFlag}">
                                        <option th:selected="${organCoursePo.vipFlag==true}" value=true>是</option>
                                        <option th:selected="${organCoursePo.vipFlag==false}" value=false>否</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-9">
                                <label>产品内容 <span class="required-sign">*</span></label>
                                <div id="umeditor" name="content" style="height:350px">
                                    <p>请填写您的产品内容</p>
                                </div>


                                <div id="editor">
                                </div>
                                <input id="courseContent" name="organCoursePo.courseContent" type="hidden"
                                       th:value="${organCoursePo.courseContent}">
                                <div id="preCodeBox"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12" th:if="${supportTag}">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <label class="course-label">选择称号（<span class="required-sign">不超过6个</span>）

                            <span style="float:right;margin-top: 5px" class="label ogn-tag">私有称号</span>
                            <span style="float:right;margin-top: 5px" class="label constant-tag">公用称号</span>
                        </label>
                    </div>
                    <div class="ibox-content">
                        <div id="tagBox" style="background: #eee;min-height: 250px;padding: 20px 0px">
                            <div id="constantTagBox" class="col-sm-12">

                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <label class="course-label">设置图片（<span class="required-sign">必需</span>）</label>
                    </div>
                    <div class="ibox-content">
                        <div class="row" style="position:relative">
                            <div class="form-group">
                                <label class="col-sm-2">宣传图
                                    <soan class="required-sign">*</soan>
                                </label>
                                <button type="button" class="btn btn-info mainpic_url" id="mainpic_img_btn"
                                        onclick="$('#mainpic_img').click()">
                                    <span>选择图片</span>
                                </button>
                                <input style="display:none" id="mainpic_img" type="file"
                                       onchange="uploadMainpicImg($('#mainpic_img_btn'),this)"/>
                            </div>
                            <div class="col-sm-offset-2 course-mainpic-box" style="display:inline-block;">
                                <img id="mainpic_img_url" class="course-mainpic-img-url" th:src="${mainpicImgUrl}"/>
                                <input type="hidden" name="mainpic_url" id="mainpic_url" class="required">
                                <input type="hidden" name="mainpicUrlPreCode" id="mainpic_url_preCode">
                            </div>
                            <div style="display:inline-block;width:160px;position:absolute;bottom:0;">推荐尺寸：宽320*高320
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <label class="course-label">产品班次（<span class="required-sign">*为必填</span>）</label>
                    </div>
                    <div class="ibox-content">
                        <a class="btn btn-success" type="button" onclick="createClassBox()"><i
                                class="glyphicon glyphicon-plus"></i> 添加班次</a>
                        <div class="panel-group" id="accordion">
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="col-sm-3 col-sm-offset-2" style="margin-top: 20px">
                            <button style="width:150px" class="btn-lg btn btn-primary" type="button"
                                    onclick="frmSubmit()">提 交
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

</div>
<div class="modal inmodal" id="addressModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content animated bounceInRight">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">关闭</span>
                </button>
            </div>
            <div id="apismapBox" style="height:700px">

            </div>
        </div>
    </div>
</div>

<script type="text/template" id='classCatalogTmpl'>
    <div name="organClassCatalogPos" class="organClassCatalogPos col-sm-12" style="margin:5px 0px">
        <div style="overflow:hidden">
            <div name="" class="col-sm-5 form-group">
                <label>目录标题<span class="required-sign">*</span></label>
                <input name="id" type="hidden" jprop="id" value=${id}>
                <input id="catalogTitle${tmplIndex}" name="catalogTitle" jprop="catalogTitle" class="form-control "
                       value="${catalogTitle}"
                       required="true"/>
                <input name="catalogIndex" jprop="catalogIndex" type="hidden" value=${len}>
            </div>
            <div class="col-sm-5 form-group">
                <label>开始时间<span class="required-sign">*</span></label>
                <input id="startTime${tmplIndex}" name="startTime" jprop="startTime" class="form-control laydateer "
                       value="${startTime}"
                       required="true"/>
            </div>
            <div class="col-sm-2">
                <a style="float:right;display:inline-block;margin-left:10px" href="javascript:void(0);"><span
                        class="glyphicon glyphicon-remove"
                        aria-hidden="true"
                        onclick="removeClassCatalogBox(this)"></span></a>
                <a name="insertCatalogBtn" style="float:right;" href="javascript:void(0);"><span
                        onclick="insertbeforeClassCatalogBox(this)">插入</span></a>
            </div>
        </div>


        <div class="col-sm-5 form-group">
            <label>持续时长（分钟）<span class="required-sign">*</span></label>
            <input id="duration${tmplIndex}" name="duration" jprop="duration" class="form-control " value="${duration}"
                   required="true">

        </div>

        <div class="col-sm-10 form-group">
            <label>目录描述<span class="required-sign">*</span></label>
            <textarea id="catalogDesc${tmplIndex}" name="catalogDesc" jprop="catalogDesc" class="form-control "
                      required="true">${catalogDesc}</textarea>
        </div>
    </div>
</script>
<script type="text/template" id='constantTagTmpl'>
    <div class="col-sm-2 constantTagPos" style="margin-bottom: 10px">
        <input name="tagName" jprop="tagName" type="hidden" value=${tagName}>
        <input type="checkbox" name="id" jprop="id" onclick="taglt6(this)" value="${id}">
        <input name="ognFlag" type="hidden" jprop="ognFlag" value=false>
        <span class="label constant-tag">${tagName}</span>
    </div>
</script>
<script type="text/template" id='ognTagTmpl'>
    <div class="col-sm-2 constantTagPos" style="margin-bottom: 10px">
        <input type="checkbox" name="id" jprop="id" onclick="taglt6(this)" value="${id}">
        <input name="tagName" jprop="tagName" type="hidden" value=${tagName}>
        <input name="ognFlag" jprop="ognFlag" value=true type="hidden">
        <span class="label ogn-tag">${tagName}</span>
    </div>
</script>
<script type="text/template" id='classTmpl'>
    <div name="organClassBosBox" class="panel panel-default">
        <div class="panel-heading">
            <h5 class="panel-title">
                <a name="boxTitle" data-toggle="collapse" data-parent="#accordion" href=${href}>${className}</a>
                <a style="float:right" href="javascript:void(0);"><span class="glyphicon glyphicon-remove"
                                                                        aria-hidden="true"
                                                                        onclick="removeClassBox(this)"></span></a>
            </h5>
        </div>
        <div id=${collapse} class="panel-collapse collapse in">
            <div class="panel-body ">
                <div name="organClassBos" class="organClassBos">
                    <div class="col-sm-4">
                        <input name="id" type="hidden" value="${id}">
                        <div class="form-group">
                            <label>班次名称 <span class="required-sign">*</span></label>
                            <input id="className${tmplIndex}" name="className" jprop="className" type="text"
                                   class=" form-control "
                                   value="${className}"
                                   required="true"
                                   onblur="setClassBoxTitle(this)">
                        </div>
                        <div class="form-group">
                            <label>类型 <span class="required-sign">*</span></label>
                            <select name="type" jprop="type" type="text" class="form-control classType" value="${type}"
                                    required="true">
                                <option value="normal">正常</option>
                                <option value="bespeak">预约</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>产品负责人 <span class="required-sign">*</span></label>
                            <select name="ognAccountId" jprop="ognAccountId" type="text" class=" form-control "
                                    required="true">
                            </select>
                        </div>
                        <div class="form-group">
                            <label>价格(元) <span class="required-sign">*</span></label>
                            <input id="classPrize${tmplIndex}" name="classPrize" jprop="classPrize" type="text"
                                   class=" form-control number-input"
                                   value="${classPrize}">
                        </div>
                        <div class="form-group discountAmount">
                            <label><input type="checkbox" class="isDiscount">优惠后价格(元) </label>
                            <input name="discountAmount" jprop="discountAmount" type="text" readonly="true"
                                   class=" form-control"
                                   value="${discountAmount}">
                        </div>
                        <div class="form-group">
                            <label>是否限制报名人数 <span class="required-sign">*</span></label>
                            <select name="enterLimitFlag" jprop="enterLimitFlag" type="text" class=" form-control "
                                    value="${enterLimitFlag}">
                                <option value=false>否</option>
                                <option value=true>是</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>要求报名人数 </label>
                            <input id="enterRequireNum${tmplIndex}" name="enterRequireNum" jprop="enterRequireNum"
                                   type="text" class="form-control"
                                   value="${enterRequireNum}"
                                   readonly="true">
                        </div>
                        <div class="form-group">
                            <label>联系电话 <span class="required-sign">*</span></label>
                            <input id="phone${tmplIndex}" name="phone" jprop="phone" type="text" class="form-control"
                                   required="true"
                                   value="${phone}">
                        </div>
                        <div class="form-group">
                            <label>上课地址 <span class="required-sign">*</span></label>
                            <div style="overflow:hidden">
                                <div class="col-sm-11" style="margin-left: -15px">
                                    <input id="address${tmplIndex}" name="address" jprop="address" type="text"
                                           class="form-control" required="true"
                                           value="${address}">
                                </div>
                                <div class="col-sm-1" style="height:34px">
                                    <a href="javascript:void(0)" onclick="apisMapClick(this)">
                                    <span style="display: inline-block;margin-top: 10px"
                                          class="glyphicon glyphicon-map-marker"
                                          aria-hidden="true"></span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>经度 <span class="required-sign">*</span></label>
                            <input id="addressLng${tmplIndex}" name="addressLng" jprop="addressLng" type="text"
                                   class="form-control digit"
                                   required="true"
                                   value="${addressLng}">
                        </div>
                        <div class="form-group">
                            <label>纬度 <span class="required-sign">*</span></label>
                            <input id="addressLat${tmplIndex}" name="addressLat" jprop="addressLat" type="text"
                                   class="form-control digit"
                                   required="true"
                                   value="${addressLat}">
                        </div>
                        <div class="form-group">
                            <label><span name="courseNumLabel">总计目录</span> <span class="required-sign">*</span></label>
                            <input id="courseNum${tmplIndex}" name="courseNum" jprop="courseNum"
                                   class=" form-control "
                                   value="${courseNum}"
                                   readonly=true>
                        </div>
                    </div>
                    <div name="organClassCatalogPosBox" class="form-group col-sm-8 well ">
                        <div>
                            <a class="btn btn-success" type="button" onclick="addClassCatalogBox(this)"><i
                                    class="glyphicon glyphicon-plus"></i> 添加班次目录</a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</script>
<script type="text/template" id='selectModelTmpl'>
    <option value=${id}>${text}</option>
</script>
<script th:replace="~{fragments/scripts}"></script>
<script th:src="@{/umeditor/umeditor.config.js}"></script>
<script th:src="@{/umeditor/umeditor.js}"></script>
<script th:src="@{/umeditor/lang/zh-cn/zh-cn.js}"></script>
<script th:src="@{/js/plugins/validate/jquery.validate.min.js}"></script>
<script th:src="@{/js/plugins/validate/messages_zh.min.js}"></script>

<script th:src="@{/js/demo/form-validate-demo.min.js}"></script>
<script th:src="@{/js/jquery.tmpl.min.js}"></script>
<script th:src="@{/js/laydate/laydate.js}"></script>
<script th:src="@{/modules/organCourse.js}"></script>
<script th:inline="javascript">
    var $address;
    var $lat
    var $lng
    var um = UM.getEditor('umeditor', {imageUrl: "/auth/organCourse/uploadCourseDescPic",});

    //organCoursePo.EnterTimeEnd提交框name属性
    function organCoursePoEnterTimeEnd() {
        if ($("#enterTimeEnd").val()) {
            $("#enterTimeEnd").attr("name", "organCoursePo.enterTimeEnd")
        } else {
            $("#enterTimeEnd").attr("name", "")
        }
    }

    //科目一级目录
    function changeFirstCatalog() {
        var firstConstantCatalogId = $("#firstConstantCatalogId").val()
        if (!firstConstantCatalogId) {
            $("#courseCatalogId").html($("#selectModelTmpl").tmpl([{id: "", text: "二级目录"}]))
            return
        }
        var text = $("#firstConstantCatalogId").find("option[value=" + firstConstantCatalogId + "]").text()
        $("#courseCatalogId").html($("#selectModelTmpl").tmpl([{id: firstConstantCatalogId, text: text}]))
        $.ajax({
            type: "GET",
            url: "/auth/organCourse/changeFirstCatalog/" + firstConstantCatalogId,
            success: function (data) {
                if (data.success) {
                    if (data.result) {
                        var selectModel = []
                        var res = data.result
                        for (var item in res) {
                            selectModel.push({id: res[item].id, text: res[item].label})
                        }
                        if (selectModel.length > 0) {
                            $("#courseCatalogId").append($("#selectModelTmpl").tmpl(selectModel))
                        }
                    }
                }
            },
            error: function (XMLHttpRequest) {
                toastr_error_system(XMLHttpRequest.status);
            }
        })
    }

    //初始化一级目录，二级目录
    function catalogInit(firtCatalog, secondCatalog, secondCatalogs) {
        $("#firstConstantCatalogId").val(firtCatalog)
//        $("#courseCatalogId").html($("#selectModelTmpl").tmpl([{id:"",text:"二级目录"}]))
        if (secondCatalogs) {
            var selectModel = []
            for (var item in secondCatalogs) {
                selectModel.push({id: secondCatalogs[item].id, text: secondCatalogs[item].label})
            }
            if (selectModel.length > 0) {
                $("#courseCatalogId").html($("#selectModelTmpl").tmpl(selectModel))
            }
        }
        $("#courseCatalogId").val(secondCatalog)
    }

    //教师map
    var organAccountSelectModel = [[${organAccountSelectModel}]]
    /* 上传宣传图 */
    function uploadMainpicImg($btn, ele) {
        $btn.attr("disabled", true)
        data = new FormData();
        data.append("file", $("#mainpic_img")[0].files[0]);
        $.ajax({
            type: "POST",
            url: "/auth/organCourse/uploadMainpic",
            data: data,
            contentType: false,
            processData: false,
            beforeSend: function () {
                layer.load(2, {shade: [0.1, '#fff']});
            },
            success: function (data) {
                if (data.success) {
                    $("#mainpic_img_url").attr("src", data.result.fileUrl)
                    $("#mainpic_url").val(data.result.fileUrl)
                    $("#mainpic_url_preCode").val(data.result.preCode)
                    $("#pic-error").remove()
                }
            },
            error: function (XMLHttpRequest) {
                toastr_error_system(XMLHttpRequest.status);
            },
            complete: function () {
                $(ele).attr("value", null);
                $btn.attr("disabled", false)
                layer.closeAll();
            }
        })
    }

    /*向前插入课时*/
    function insertbeforeClassCatalogBox(ele) {
        $(ele).parents(".organClassCatalogPos").eq(0).before($("#classCatalogTmpl").tmpl([{
            tmplIndex: tmplIndex(), catalogTitle: "目录标题",
        }]))
        var len = $(ele).parents("div[name='organClassCatalogPosBox']").eq(0).find(".organClassCatalogPos").length
        $(ele).parents(".organClassBos").eq(0).find("input[name='courseNum']").eq(0).val(len)
        $(ele).parents(".organClassCatalogPos").eq(0).prev(".organClassCatalogPos").find(".laydateer").each(function () {
            laydate.render({
                type: 'datetime',
                elem: this,
                trigger: 'click'
            });
        })
    }

    /* 向后新增班次课时目录*/
    function addClassCatalogBox(ele) {
        var len = $(ele).parents("div[name='organClassCatalogPosBox']").eq(0).find(".organClassCatalogPos").length
        var $box = $(ele).parents("div[name='organClassCatalogPosBox']").eq(0)
        var catalog = [{tmplIndex: tmplIndex(), catalogTitle: "目录标题" + (len + 1), len: len + 1}]

        $box.append($("#classCatalogTmpl").tmpl(catalog))
        $(ele).parents(".organClassBos").eq(0).find("input[name='courseNum']").eq(0).val(len + 1)

        $box.find(".organClassCatalogPos:last").find(".laydateer").each(function () {
            laydate.render({
                type: 'datetime',
                elem: this,
                trigger: 'click'
            });
        });

    }

    /* 删除课时*/
    function removeClassCatalogBox(ele) {
        var len = $(ele).parents("div[name='organClassCatalogPosBox']").eq(0).find(".organClassCatalogPos").length
        var $box = $(ele).parents(".organClassBos").eq(0)
        if (len == 1) {
            return
        } else {
            $(ele).parents(".organClassCatalogPos").eq(0).remove()
            var lenRes = $box.find(".organClassCatalogPos").length
            $box.find("input[name='courseNum']").eq(0).val(lenRes)
        }
    }


    /*勾选称号不超过6个*/
    function taglt6(ele) {
        var len = $("#tagBox").find("input[type='checkbox']:checked").length
        if (len > 6) {
            if ($(ele).is(":checked")) {
                $(ele).attr("checked", false)
                toastr.error("称号不得超过6个!")
            }
        }
    }
    /* 增加班次*/
    function createClassBox() {
        var len = $("#accordion").find("div[name='organClassBosBox']").length
        var classes = [{
            tmplIndex: tmplIndex(),
            href: "#collapse" + (len + 1),
            collapse: "collapse" + (len + 1),
            className: "班次",
            discountAmount: "",
            classPrize: 0,
            phone: $("#ognPhone").val(),
            addressLng: $("#ognLng").val(),
            addressLat: $("#ognLat").val(),
            address: $("#ognAddress").val()
        }]
        $("#accordion").append($("#classTmpl").tmpl(classes));
        var htmls = '';
        for (var item in organAccountSelectModel) {
            htmls = htmls + "<option value='" + organAccountSelectModel[item].id + "'>" + organAccountSelectModel[item].accountName + "</option>"
        }
        $("#accordion").find("div[name='organClassBosBox']:last-child").find("select[name='ognAccountId']").eq(0).html(htmls);
        bindNumberInput($("#accordion"))

        classBoxDynamicInitLast()
        bindChangeClassTypeEvent($("#accordion").find("div.organClassBos:last"))

    }

    /* 增加班次时其下字段的绑定事件*/
    function classBoxDynamicInitLast() {
        //是否限制报名人数 框绑定事件
        $("#accordion").find("select[name='enterLimitFlag']:last").on("change", function () {
            var $enterRequireNum = $(this).parents("div.organClassBos").eq(0).find("input[name='enterRequireNum']").eq(0)
            if ($(this).val() == "false") {
                $enterRequireNum.attr("readonly", true).val("").removeAttr("required")
            } else {
                $enterRequireNum.removeAttr("readonly").attr("required", true)
            }
        })
        //数字框去尾部0绑定
        $("#accordion").find(".organClassBos:last").find("input.digit").on("blur", function () {
            $(this).val(parseFloat($(this).val()))
        })
        //优惠价格勾选绑定
        $("#accordion").find(".organClassBos:last").find(".isDiscount").eq(0).on("click", function () {
            var isDiscount = $(this).is(":checked")
            if (isDiscount) {
                $(this).parents(".discountAmount").eq(0).find("input[name='discountAmount']").attr("readonly", false).attr("required", true)
            } else {
                $(this).parents(".discountAmount").eq(0).find("input[name='discountAmount']").val("").attr("readonly", true).attr("required", false)
            }
        })

    }
    /* 班次初始化时其下字段的绑定事件*/
    function classBoxDynamicInitAll() {
        $(".organClassBos").each(function () {
            var enterLimitFlag = $(this).find("select[name='enterLimitFlag']").eq(0).val()
            var $enterRequireNum = $(this).find("input[name='enterRequireNum']").eq(0)
            if (enterLimitFlag == "false" ? false : true) {
                $enterRequireNum.prop("readonly", false)
            } else {
                $enterRequireNum.prop("readonly", true)
            }
        })
        //是否限制报名人数 框绑定事件
        $("#accordion").find("select[name='enterLimitFlag']").on("change", function () {
            var $enterRequireNum = $(this).parents("div.organClassBos").eq(0).find("input[name='enterRequireNum']").eq(0)
            if ($(this).val() == "false") {
                $enterRequireNum.attr("readonly", true).val("").removeAttr("required")
            } else {
                $enterRequireNum.removeAttr("readonly").attr("required", true)
            }
        })

        $("#accordion").find(".organClassBos").find("input.digit").on("blur", function () {
            $(this).val(parseFloat($(this).val()))
        })

        //优惠价格勾选
        $(".organClassBos").find("input[name='discountAmount']").each(function () {
            if ($(this).val()) {
                $(this).parents(".discountAmount").eq(0).find(".isDiscount").eq(0).attr("checked", true)
                $(this).attr("readonly", false).attr("required", true)
            } else {
                $(this).val("").attr("readonly", true).attr("required", false)
            }
        })
        $(".organClassBos").find(".isDiscount").eq(0).on("click", function () {
            var isDiscount = $(this).is(":checked")
            if (isDiscount) {
                $(this).parents(".discountAmount").eq(0).find("input[name='discountAmount']").attr("readonly", false).attr("required", true)
            } else {
                $(this).parents(".discountAmount").eq(0).find("input[name='discountAmount']").val("").attr("readonly", true).attr("required", false)
            }
        })
    }
    /*删除班次*/
    function removeClassBox(ele) {
        $(ele).parents("div[name='organClassBosBox']").remove();
    }
    /* 设置班次名称*/
    function setClassBoxTitle(ele) {
        $(ele).parents("div[name='organClassBosBox']").find("a[name='boxTitle']").text($(ele).val())
    }
    /*班次类型绑定事件*/
    function bindChangeClassTypeEvent($box) {
        if ($box != undefined) {
            $box.on("change", "select.classType", function () {
                var type = $(this).val()
                var $div = $(this).parents("div.organClassBos").eq(0)
                if (type == "normal") {
                    $div.find("div[name='organClassCatalogPosBox']").show();
                    $div.find("input[name='courseNum']").eq(0).val("").attr("readonly", true).attr("required", false)
                    $div.find("span[name='courseNumLabel']").eq(0).text("总计目录")
                } else if (type == "bespeak") {
                    $div.find("div[name='organClassCatalogPosBox']").hide();
                    $div.find("input[name='courseNum']").attr("readonly", false).attr("required", true)
                    $div.find("span[name='courseNumLabel']").eq(0).text("总预约次数")
                    $div.find("div.organClassCatalogPos").remove()
                }
            })
        }
    }
    /*班次类型初始化事件*/
    function initChangeClassTypeEvent($box) {
        if ($box != undefined) {
            $box.each(function () {
                var type = $(this).find("select.classType").eq(0).val()
                var $div = $(this)
                if (type == "normal") {
                    $div.find("div[name='organClassCatalogPosBox']").show();
                    $div.find("input[name='courseNum']").eq(0).attr("readonly", true).attr("required", false)
                } else if (type == "bespeak") {
                    $div.find("div[name='organClassCatalogPosBox']").hide();
                    $div.find("input[name='courseNum']").attr("readonly", false).attr("required", true)
                }
            })
        }
    }
    function beforeValidAbledOrganClassCatalogPos() {
        $("div[name='organClassCatalogPos']").find("input[name='startTime']").each(function () {
            $(this).attr("disabled", false);

        })
    }

    function beforeSubmitFormatInputInnerName() {
        var $organClassBos = $("div.organClassBos")
        for (var i = 0; i < $organClassBos.length; i++) {
            $organClassBos.eq(i).attr("name", "organClassBos[" + i + "]")
            $organClassBos.eq(i).find("input,select").each(function () {
                $(this).attr("name", $organClassBos.eq(i).attr("name") + "." + $(this).attr("jprop"))
            })

            var $organClassCatalogPos = $organClassBos.eq(i).find("div.organClassCatalogPos")
            for (var j = 0; j < $organClassCatalogPos.length; j++) {
                var parentName = $organClassCatalogPos.eq(j).parents("div.organClassBos").eq(0).attr("name")
                $organClassCatalogPos.eq(j).attr("name", parentName + ".organClassCatalogPos[" + j + "]")
                $organClassCatalogPos.eq(j).find("input,textarea").each(function () {
                    if ($(this).attr("name") == "catalogIndex") {
                        $(this).val(j + 1)
                    }
                    $(this).attr("name", $organClassCatalogPos.eq(j).attr("name") + "." + $(this).attr("jprop"))
                })
            }
        }


        var $constantTags = $("div.constantTagPos")
        var tagCount = 0
        for (var i = 0; i < $constantTags.length; i++) {
            if ($constantTags.eq(i).find("input[type='checkbox']").length > 0
                && !$constantTags.eq(i).find("input[type='checkbox']").eq(0).is(':checked')) {
                $constantTags.eq(i).find("input").each(function () {
                    $(this).attr("name", "")
                })
            } else {
                $constantTags.eq(i).find("input").each(function () {
                    $(this).attr("name", "constantTagPos[" + tagCount + "]." + $(this).attr("jprop"))
                })
                tagCount++;
            }
        }
    }

    function beforeSubmitCheckCourseDescPic() {
        var $imgArray = $("#umeditor").find("img")
        var $preCodes = $("#preCodeBox")
        for (var i = 0; i < $imgArray.length; i++) {
//            var preCode = $imgArray.eq(i).attr("precode")
            var preCode = $imgArray.eq(i).attr("_src")
            var htmls = '<input type="hidden" name="courseDescPicPreCodes" value="' + preCode + '">'
            $preCodes.append(htmls)
        }
    }
    /*提交前正常班次下课时不为0*/
    function beforeSubmitClassRequiredCatalog() {
        var flag = true
        var $box = $("div[name='organClassCatalogPosBox']")
        for (var i = 0; i < $box.length; i++) {
            var $div = $box.eq(i).parents("div.organClassBos").eq(0)
            var classType = $div.find(".classType").eq(0).val()
            if ($box.eq(i).find("div.organClassCatalogPos").length == 0 && classType == "normal") {
                flag = false
            }
            if (!flag) {
                break
            }
        }
        return flag
    }

    function beforeSubmitCheckCourseMainPic() {
        if ($("#courseId").val()) {
            if (!$("#mainpic_img_url").attr("src")) {
                return checkFormCreateImgRequired([{eleId: "mainpic_url", msg: "请上传宣传图"}])
            } else {
                return true
            }
        } else {
            return checkFormCreateImgRequired([{eleId: "mainpic_url", msg: "请上传宣传图"}])
        }

    }

    function beforeSubmitCourseContent(content) {
        $("#courseContent").val(content)
    }

    function frmSubmit() {
        beforeValidAbledOrganClassCatalogPos()
        organCoursePoEnterTimeEnd()

        if (!$("#frm").valid()) {
            console.log("valid fail")
            return;
        }


        beforeSubmitFormatInputInnerName()

        if (UM.getEditor('umeditor').getContentTxt() == "") {
            toastr.error("请填写产品内容！")
            return
        }
        beforeSubmitCheckCourseDescPic()
        if ($("div[name='organClassBosBox']").length == 0) {
            toastr.error("请创建班次!")
            return
        }
        if (!beforeSubmitClassRequiredCatalog()) {
            toastr.error("请添加班次目录!")
            return
        }


        if (!beforeSubmitCheckCourseMainPic()) {
            return
        }
        beforeSubmitCourseContent($("#umeditor").html());

        var url = "/auth/organCourse/merchantCreate"
        if ($("#courseId").val()) {
            url = "/auth/organCourse/merchantUpdate"
        }


        $.ajax({
            type: "POST",
            data: $("#frm").serialize(),
            url: url,
            beforeSend: function () {
                layer.load(2, {shade: [0.1, '#fff']});
            },
            success: function (data) {
                if (data.success) {
                    toastr_success(null, document.referrer)
                } else {
                    toastr.error(data.errorDescription);
                }
            },
            error: function (XMLHttpRequest) {
                toastr_error_system(XMLHttpRequest.status);
            },
            complete: function () {
//                $("#enterTimeEnd").attr("name", "organCoursePo.enterTimeEnd")
                layer.closeAll();
            }
        })
    }

    //腾讯地图插件
    function apisMapClick(ele) {

        $("#addressModal").modal("show")
        $address = $(ele).parents(".organClassBos").eq(0).find("input[name='address']").eq(0)
        $lng = $(ele).parents(".organClassBos").eq(0).find("input[name='addressLng']").eq(0)
        $lat = $(ele).parents(".organClassBos").eq(0).find("input[name='addressLat']").eq(0)

    }

    $(document).ready(function () {
        apisMapClickCallback($("#apismapBox"), function (loc) {
            $address.val(loc.poiaddress + loc.poiname)
            $lng.val(loc.latlng.lng)
            $lat.val(loc.latlng.lat)
            $("#addressModal").modal("hide")
        })

        jqValidCheckById()
        //修改页面初始化start
        if ([[${organCoursePo.id}]]) {

            $("#umeditor").html($("#courseContent").val())

            //一级目录，二级目录
            catalogInit([[${firstConstantCatalog}]], [[${organCoursePo.courseCatalogId}]], [[${secondCatalogs}]])
            //班次start
            var organClassBos = [[${organClassBos}]]
            for (var i = 0; i < organClassBos.length; i++) {
                var len = $("#accordion").find("div[name='organClassBosBox']").length
                var classes = [{
                    id: organClassBos[i].id, href: "#collapse" + (len + 1), collapse: "collapse" + (len + 1),
                    className: organClassBos[i].className, classPrize: organClassBos[i].classPrize,
                    discountAmount: organClassBos[i].discountAmount, enterLimitFlag: organClassBos[i].enterLimitFlag,
                    enterRequireNum: organClassBos[i].enterRequireNum, courseNum: organClassBos[i].courseNum,
                    vipFlag: organClassBos[i].vipFlag, phone: organClassBos[i].phone, address: organClassBos[i].address,
                    addressLng: organClassBos[i].addressLng,
                    addressLat: organClassBos[i].addressLat,
                    type: organClassBos[i].type
                }]
                $("#accordion").append($("#classTmpl").tmpl(classes));

                var htmls = '<option value="">请选择</option>';
                for (var item in organAccountSelectModel) {
                    if (organAccountSelectModel[item].id == organClassBos[i].ognAccountId) {
                        htmls = htmls + "<option selected value='" + organAccountSelectModel[item].id + "'>" + organAccountSelectModel[item].accountName + "</option>"
                    } else {
                        htmls = htmls + "<option value='" + organAccountSelectModel[item].id + "'>" + organAccountSelectModel[item].accountName + "</option>"
                    }
                }
                $("#accordion").find("div[name='organClassBosBox']:last").find("select[name='ognAccountId']").eq(0).html(htmls);
                var organClassCatalogPos = organClassBos[i].organClassCatalogPos

                var $box = $("#accordion").find("div[name='organClassCatalogPosBox']:last")
                var catalog = []
                if (null != organClassCatalogPos && organClassCatalogPos.length) {
                    for (var j = 0; j < organClassCatalogPos.length; j++) {
                        catalog.push({
                            tmplIndex: tmplIndex(),
                            id: organClassCatalogPos[j].id,
                            len: j + 1,
                            startTime: new Date(organClassCatalogPos[j].startTime).Format('yyyy-MM-dd HH:mm:ss'),
                            duration: organClassCatalogPos[j].duration,
                            catalogTitle: organClassCatalogPos[j].catalogTitle,
                            catalogDesc: organClassCatalogPos[j].catalogDesc
                        })
                    }
                    $box.append($("#classCatalogTmpl").tmpl(catalog))
                }

            }
            $("#accordion").find("select[name='enterLimitFlag']").each(function () {
                var val = $(this).attr("value")
                $(this).val(val)
            })
            $("#accordion").find("select[name='vipFlag']").each(function () {
                var val = $(this).attr("value")
                $(this).val(val)
            })
            $("#accordion").find("select[name='type']").each(function () {
                var val = $(this).attr("value")
                $(this).val(val)
            })

            $("#accordion").find("div[id^='collapse']").removeClass("in");//选项卡折叠
            $("#accordion").find("select[name='enterLimitFlag']").each(function () {
                var $enterRequireNum = $(this).siblings("input[name='enterRequireNum']").eq(0)
                if ("false" == $(this).val()) {
                    $enterRequireNum.attr("readonly", true)
                }
            })

            classBoxDynamicInitAll()
            initChangeClassTypeEvent($("div.organClassBos"))
            bindChangeClassTypeEvent($("div.organClassBos"))
            //班次end

        }
        //修改页面初始化end
        if ([[${supportTag}]]) {
            //公用称号start
            var tagList = [[${ognTagList}]]
            var constantTag = []
            var ognTag = []

            for (item in tagList) {
                if (tagList[item].ognFlag) {
                    ognTag.push({
                        id: tagList[item].id,
                        tagName: tagList[item].tagName,
                        ognFlag: tagList[item].ognFlag
                    })
                } else {
                    constantTag.push({
                        id: tagList[item].id,
                        tagName: tagList[item].tagName,
                        ognFlag: tagList[item].ognFlag
                    })
                }
            }
            $("#constantTagBox").append($("#constantTagTmpl").tmpl(constantTag));
            $("#constantTagBox").append($("#ognTagTmpl").tmpl(ognTag));

            //公用称号end
            //产品称号start
            if ([[${organCourseTagBos}]]) {
                var organCourseTagBos = [[${organCourseTagBos}]]
                for (item in organCourseTagBos) {
                    $("#constantTagBox").find("input[name='id']").each(function () {
                        if ($(this).val() == organCourseTagBos[item].tagId) {
                            $(this).attr("checked", true)
                        }
                    })
                }
            }

            //产品称号end
        }


        laydate.render({
            elem: '#onlineTime',
            type: 'datetime'
        });
        laydate.render({
            elem: '#enterTimeStart',
            type: 'datetime'
        });
        laydate.render({
            elem: '#enterTimeEnd',
            type: 'datetime'
        });
        lay('.laydateer').each(function () {
            laydate.render({
                type: 'datetime',
                elem: this,
                trigger: 'click'
            });
        });


//        $.validator.addMethod("isMobile", function (value, element) {
//            var length = value.length;
//            var mobile = /^(((13[0-9]{1})|(15[0-9]{1}))+\d{8})$/
//            return this.optional(element) || (length == 11 && mobile.test(value));
//        }, "请填写正确的手机号码!");
        $.validator.addMethod("expr_lng_lat", function (value, element) {
            var expr = expr_lng_lat
            return this.optional(element) || expr.test(value);
        }, "小数位数为1-6位!");
        $("#frm").validate({
            rules: {
                enterRequireNum: {digits: true, min: 1},
                courseNum: {digits: true, min: 1},
                duration: {digits: true},
                addressLng: {number: true, max: 180, min: -180, expr_lng_lat: true},
                addressLat: {number: true, max: 90, min: -90, expr_lng_lat: true},
                classPrize: {number: true, min: 0},
                discountAmount: {number: true, min: 0},
            },
            messages: {
                addressLng: {
                    number: "经度为-180到180的数字!",
                    max: "经度为-180到180的数字!",
                    min: "经度为-180到180的数字!",
                    expr_lng_lat: "小数位数为1-6位!"
                },
                addressLat: {
                    number: "纬度为-90到90的数字!",
                    max: "纬度为-90到90的数字!",
                    min: "纬度为-90到90的数字!",
                    expr_lng_lat: "小数位数为1-6位!"
                },
                courseNum: "请输入正整数！"
            },
        })

    });


</script>
</body>
</html>