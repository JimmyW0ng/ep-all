<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sd="http://www.thymeleaf.org/spring-data"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
>
<head th:replace="~{fragments/header :: common_header}">

</head>
<header>
    <th:block layout:fragment="links">

    </th:block>
</header>
<body>
<div>
    <div class="col-lg-12">

        <div class="panel">
            <div class="panel-heading">

            </div>
            <div class="panel-heading" style=" padding: 15px 15px 5px">
                <form class="form-inline" id="query-form" role="form" >
                    <div class="form-group">
                        <input type="text" class="form-control " name="mobile" th:value="${map.get('mobile')}"
                               placeholder="会员账号" >
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control " name="childTrueName" th:value="${map.get('childTrueName')}"
                               placeholder="姓名">
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control " name="childNickName"
                               th:value="${map.get('childNickName')}"
                               placeholder="昵称">
                    </div>

                    <div class="form-group">
                        <input type="text" class="form-control " name="courseName" th:value="${map.get('courseName')}"
                               placeholder="课程">
                    </div>

                    <div class="form-group">
                        <input type="text" class="form-control " name="className" th:value="${map.get('className')}"
                               placeholder="班次">
                    </div>

                    <div class="form-group ">
                        <select class="form-control" name="status" id="type" style="width:182px;" >
                            <option value>状态</option>
                            <option th:each="state : ${T(com.ep.domain.repository.domain.enums.EpOrderStatus).values()}"
                                    th:value="${state}"
                                    th:selected="${#stringTools.equals(state,map.get('status'))}"
                                    th:text="#{EpOrderStatus.+${state.literal}}">
                            </option>
                        </select>
                    </div>
                    <div class="form-group mr10">
                        <div class="input-group input-large">
                            <input type="text" class="form-control  startTime" name="crStartTime" id="crStartTime"
                                   th:placeholder="创建时间从" th:value="${map.get('crStartTime')}"
                            >
                            <span class="input-group-addon">到</span>
                            <input type="text" class="form-control  endTime" name="crEndTime" id="crEndTime"
                                   th:placeholder="到" th:value="${map.get('crEndTime')}"
                            >
                        </div>
                    </div>


                    <div class="form-group" style="vertical-align: top;">
                        <button class="btn btn-primary" id="query-button" type="button">查询</button>
                        <button class="btn btn-warning" id="rest-button" type="button">重置</button>
                    </div>

                </form>
                <div style="text-align: right">
                    <button class="btn btn-info" onclick="batchOrderSuccess()">批量报名</button>
                </div>
            </div>
            <div class="panel-body">

                <div id="editable_wrapper" class="dataTables_wrapper form-inline" role="grid"
                     sd:page-object="${page}">
                    <!--Userlist start-->
                    <table class="table table-striped table-hover table-bordered dataTable" id="editable"
                           aria-describedby="editable_info">
                        <thead>
                        <tr>
                            <th></th>
                            <th><a class="sorted" sd:pagination-sort="id">ID</a></th>
                            <th>会员账号</th>
                            <th>姓名</th>
                            <th>昵称</th>
                            <th>课程</th>
                            <th>班次</th>
                            <th>价格</th>
                            <th>状态</th>
                            <th>备注</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="tbody">
                        <tr th:each="bo:${page.content}">
                            <td><input  type="checkbox" th:value="${bo.id}" onclick="checkOrderSuccess(this)"></td>
                            <td th:text="${bo.id}"></td>
                            <td th:text="${bo.mobile}"></td>
                            <td th:text="${bo.childTrueName}"></td>
                            <td th:text="${bo.childNickName}"></td>
                            <td th:text="${bo.courseName}"></td>
                            <td style="display: none" name="classId" th:text="${bo.classId}"></td>
                            <td th:text="${bo.className}"></td>
                            <td th:text="${bo.prize}"></td>
                            <td style="display: none" name="status" th:text="${bo.status}"></td>
                            <td name="statusZh" th:text="#{EpOrderStatus.+${bo.status}}"></td>

                            <td th:text="${bo.remark}"></td>
                            <td th:text="${bo.createAt}"></td>
                            <td name="button">
                                <a name="success" class="btn btn-xs btn-info" style="display: none"
                                   th:onclick="'orderSuccess(this,'+${bo.id}+','+${bo.classId}+')'">报名成功</a>
                                <!--<a class="btn btn-xs btn-primary" th:href="@{/auth/organAccount/updateInit/}+${bo.id}">修改</a>-->
                                <a name="refuse" class="btn btn-xs btn-danger" style="display: none" href="javascript:void(0)" th:onclick="'refuseBox('+${bo.id}+')'">拒绝</a>
                                <a name="cancel" class="btn btn-xs btn-info" style="display: none" th:value="${bo.status}" th:onclick="'orderCancelBox(this,'+${bo.id}+')'">取消</a>

                            </td>

                        </tr>
                        </tbody>
                    </table>
                    <!--Userlist end-->

                    <div class="row mt15">
                        <div class="col-lg-6">
                            <label class="fl" sd:page-size-selector="dropdown">
                                <select size="1" name="editable-sample_length" aria-controls="editable-sample"
                                        class="form-control xsmall" sd:page-size-selector="default">

                                </select>
                            </label>
                            <span class="fl pl15 pt10" sd:pagination-summary=""></span>
                        </div>

                        <div class="col-lg-6">
                            <ul class="pagination pagination-sm pull-right" sd:pagination="full">

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal inmodal" id="uploadModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated bounceInRight">

            <input type="hidden" id="sourceId">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
                </button>
                <h3 style="text-align: left">确认拒绝</h3>

            </div>
            <div class="modal-body">
                <label>备注：</label>
                <textarea class="form-control" id="refuseRemark"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="refuseDo()">保存</button>
            </div>

        </div>
    </div>
</div>


<script th:replace="~{fragments/scripts}"></script>


<script th:inline="javascript">
    var EpOrderStatus={save:"保存",
        success:"成功",
    opening:"已开班",
    end:"结束",
    refuse:"拒绝",
    cancel:"取消"}
    
    function checkOrderSuccess(ele) {
        var status=$(ele).parent().siblings("td[name='status']").eq(0).html()
        if(status=="save"&&$(ele).is(':checked')){
            $(ele).attr("checked",true)
        }else{
            $(ele).attr("checked",false)
        }
    }
    
    function batchOrderSuccess() {
        var batchOrder=[]
        $("#tbody tr").find("input[type='checkbox']:checked").each(function () {
            var id=$(this).attr("value")
            var classId=$(this).parent().siblings("td[name='classId']").eq(0).html()
            batchOrder.push({id:id,classId:classId});
        })
        if(batchOrder.length==0){
            toastr.error("请先勾选名单");
        }
//        console.log(batchOrder)
        $.ajax({
            type:"POST",
            url:"/auth/order/batchOrderSuccess",
            data: JSON.stringify(batchOrder),
            contentType: "application/json;charset=utf-8",
            success:function () {
                toastr_success(null,"/auth/order/index")

            }
        })
    }
    function buttonByStatus($box,status) {
        if(status=="success"||status=="refuse"){
            $box.find("a").hide()
            $box.find("a[name='cancel']").show()
        }
        if(status=="save"){
            $box.find("a").hide()
            $box.find("a[name='success']").show()
            $box.find("a[name='refuse']").show()
        }
        
    }
    function orderSuccess(ele,id,classId) {
        $.ajax({
            type:"POST",
            url:"/auth/order/orderSuccess",
            data:{id:id,classId:classId},
            success:function (data) {
                if(data.success){
                    $(ele).parents("tr").eq(0).find("td[name='status']").html(data.result)
                    $(ele).parents("tr").eq(0).find("td[name='statusZh']").html(EpOrderStatus[data.result]);
                    buttonByStatus($(ele).parent(),data.result)
                } else {
                    toastr.error("操作失败，原因：" + data.errorDescription);
                }
            },
            error: function (XMLHttpRequest) {
                toastr_error_system(XMLHttpRequest.status);
            }
        })
    }

    function refuseBox(sourceId) {
        $("#uploadModal").modal("show")
        $("#sourceId").val(sourceId)
    }
    function refuseDo() {
        $.ajax({
            type:"GET",
            url:"/auth/order/orderRefuse?id="+$("#sourceId").val()+"&remark="+$("#refuseRemark").val(),
            success:function (data) {
                if(data.success){
                    toastr_success(null,"/auth/order/index")
                }else{
                    toastr_error(null,"/auth/order/index")
                }
            }
        })

    }
    function orderCancelBox(ele,id) {
        parent.layer.alert('确认取消', {
                icon: 1,
            },
            function (index) {
                orderCancelDo(id,$(ele).attr("value"));
                parent.layer.close(index);
            })
    }
    function orderCancelDo(id,status) {
        $.ajax({
            type:"GET",
            url:"/auth/order/orderCancel?id="+id+"&status="+status,
            success:function (data) {
                if(data.success){
                    toastr_success(null,'/auth/order/index');
                }
            }
        })

    }
    $(function () {
        $("#tbody tr").each(function () {
            var $box=$(this).find("td[name='button']").eq(0)
            var status=$(this).find("td[name='status']").eq(0).html()
            buttonByStatus($box,status)
//            if($(this).find("td[name='status']").eq(0).html()=="save"){
//                $(this).find("a[name='success']").show()
//                $(this).find("a[name='refuse']").show()
//            }else{
//                $(this).find("a[name='success']").hide()
//                $(this).find("a[name='refuse']").hide()
//            }
        })
    })

</script>
</body>
</html>